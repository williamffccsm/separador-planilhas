<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- Meta tags -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Planilhex: Automatizando Planilhas - Unir</title>
  <meta name="description" content="P√°gina para unir planilhas">

  <!-- Lucide -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Bootstrap 5 (CSS + JS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

  <style>
    :root {
      --neon-green: #00ff00;
      --text-color: #f5f5f5;
      --bg-translucent: rgba(255, 255, 255, 0.03);
      --border-translucent: rgba(255, 255, 255, 0.1);
      --neon-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
      --error-bg: rgba(255, 50, 50, 0.15);
      --error-border: rgba(255, 50, 50, 0.3);
      --neon-red: #ff3333;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      min-height: 100vh; background: #000; display: flex; align-items: center; justify-content: center;
      padding: 1.5rem; font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-color);
    }
    .container {
      background: var(--bg-translucent); border-radius: 1.5rem;
      box-shadow: 0 0 25px rgba(255,255,255,.1), 0 0 50px rgba(0,255,0,.05), inset 0 1px 0 rgba(255,255,255,.1);
      width: 1200px; min-height: 740px; max-width: 95vw; border: 1px solid var(--border-translucent);
      backdrop-filter: blur(20px); position: relative; transition: all .4s cubic-bezier(.4,0,.2,1); overflow: hidden;
    }
    .container::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, transparent, var(--neon-green), transparent); opacity: .6;
    }
    .container:hover {
      box-shadow: 0 0 35px rgba(255,255,255,.15), 0 0 70px rgba(0,255,0,.1), inset 0 1px 0 rgba(255,255,255,.2);
      border-color: rgba(0,255,0,.3); transform: translateY(-2px);
    }
    .content { padding: 2.5rem; }
    .header { text-align: center; margin-bottom: 1rem; position: relative; }
    .app-name h1 {
      font-size: 2.5rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-bottom: .5rem;
      background: linear-gradient(135deg, #fff, var(--neon-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      text-shadow: 0 0 20px rgba(0,255,0,.3), 0 2px 4px rgba(0,0,0,.8);
    }
    .app-name p { font-size: .95rem; color: rgba(245,245,245,.8); font-weight: 300; letter-spacing: 1px; text-shadow: 0 1px 3px rgba(0,0,0,.8); }
    .menu-toggle {
      position: absolute; top: 0; left: 0; background: var(--bg-translucent); border: 1px solid var(--border-translucent);
      border-radius: .5rem; padding: .5rem; cursor: pointer; transition: all .3s cubic-bezier(.4,0,.2,1); display: flex; z-index: 1001;
    }
    .menu-toggle:hover { background: linear-gradient(135deg, rgba(0,255,0,.15), rgba(0,255,0,.25)); border-color: var(--neon-green); box-shadow: var(--neon-shadow); }
    .menu-toggle svg { stroke: var(--neon-green); }

    /* Topo-direito: apenas bot√£o Sair */
    .header .actions {
      position: absolute; top: 0; right: 0; display: flex; gap: .5rem; padding: .5rem; z-index: 1101;
    }
    .btn-logout-top {
      background: linear-gradient(135deg, rgba(255, 51, 51, 0.10), rgba(255, 51, 51, 0.08));
      color: var(--text-color); border: 1px solid var(--error-border); border-radius: .75rem;
      padding: .55rem 1rem; display: inline-flex; align-items: center; gap: .5rem; text-decoration: none; font-weight: 600;
      transition: transform .2s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .btn-logout-top:hover {
      background: linear-gradient(135deg, rgba(255,51,51,.15), rgba(255,51,51,.25));
      border-color: var(--neon-red);
      box-shadow: 0 0 15px rgba(255,51,51,.4), 0 5px 15px rgba(255,51,51,.2);
      transform: translateY(-1px);
    }
    .btn-logout-top svg { stroke: #fff; }

    /* Drawer */
    .drawer-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,.7); backdrop-filter: blur(5px);
      opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; z-index: 1002;
    }
    .drawer-overlay.active { opacity: 1; visibility: visible; }
    .drawer-menu {
      position: fixed; top: 0; left: -320px; width: 320px; height: 100%;
      background: linear-gradient(180deg, rgba(0,0,0,.95), rgba(10,10,10,.98));
      border-right: 1px solid var(--neon-green); box-shadow: 0 0 50px rgba(0,255,0,.3);
      transition: left .3s cubic-bezier(.4,0,.2,1); z-index: 1003; overflow-y: auto; padding: 2rem 1.5rem;
    }
    .drawer-menu.active { left: 0; }
    .drawer-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-translucent); }
    .drawer-title { font-size: 1.5rem; font-weight: 700; color: var(--neon-green); text-shadow: 0 0 15px rgba(0,255,0,.5); letter-spacing: 1.5px; text-transform: uppercase; }
    .drawer-close { background: transparent; border: none; cursor: pointer; padding: .5rem; display: flex; transition: all .3s ease; }
    .drawer-close:hover { transform: rotate(90deg); }
    .drawer-close svg { stroke: var(--neon-green); }
    .drawer-nav { display: flex; flex-direction: column; gap: .75rem; }
    .drawer-nav a {
      background: var(--bg-translucent); border: 1px solid var(--border-translucent); border-radius: .75rem;
      padding: 1rem 1.25rem; color: var(--text-color); text-decoration: none; font-weight: 600; font-size: .95rem;
      transition: all .3s cubic-bezier(.4,0,.2,1); display: flex; align-items: center; gap: .75rem; position: relative; overflow: hidden;
      text-shadow: 0 1px 2px rgba(0,0,0,.8); letter-spacing: .5px;
    }
    .drawer-nav a::before {
      content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0,255,0,.2), transparent); transition: left .5s ease;
    }
    .drawer-nav a:hover::before { left: 100%; }
    .drawer-nav a:hover { background: linear-gradient(135deg, rgba(0,255,0,.15), rgba(0,255,0,.25)); border-color: var(--neon-green); box-shadow: var(--neon-shadow), 0 5px 15px rgba(0,255,0,.2); transform: translateX(5px); }
    .drawer-nav a.logout-btn { margin-top: 1rem; border-color: var(--neon-red); }
    .drawer-nav a.logout-btn:hover { background: linear-gradient(135deg, rgba(255,51,51,.15), rgba(255,51,51,.25)); border-color: var(--neon-red); box-shadow: 0 0 15px rgba(255,51,51,.4), 0 5px 15px rgba(255,51,51,.2); }

    .page-title { text-align: center; margin-bottom: 1.5rem; }
    .page-title h2 {
      font-size: 1.75rem; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase;
      background: linear-gradient(135deg, #fff, var(--neon-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
      text-shadow: 0 0 15px rgba(0,255,0,.3), 0 2px 4px rgba(0,0,0,.8);
    }

    .upload-section { margin-top: 2rem; display: flex; flex-direction: column; gap: 1.5rem; }
    .upload-btn {
      background: var(--bg-translucent); border: 1px dashed var(--border-translucent); border-radius: .75rem;
      padding: 1.5rem; text-align: center; cursor: pointer; transition: all .3s ease;
    }
    .upload-btn:hover { background: rgba(0,255,0,.1); border-color: var(--neon-green); box-shadow: var(--neon-shadow); }
    .output-name, .format-select {
      width: 100%; padding: 1rem; border: 1px solid var(--border-translucent); border-radius: .75rem; background: rgba(0,0,0,.6);
      color: var(--text-color); font-size: .95rem; transition: all .3s cubic-bezier(.4,0,.2,1);
    }
    .output-name:focus, .format-select:focus { border-color: var(--neon-green); background: rgba(0,0,0,.8); box-shadow: var(--neon-shadow), inset 0 1px 3px rgba(0,0,0,.3); outline: none; }

    #fileListContainer { display: flex; flex-direction: column; gap: .5rem; margin-top: .5rem; }
    .file-item {
      background: rgba(0,0,0,.4); border: 1px solid var(--border-translucent); padding: .75rem 1rem; border-radius: .5rem;
      display: flex; align-items: center; gap: .75rem; font-size: .9rem; transition: background .3s;
    }
    .file-item:hover { background: rgba(0,255,0,.05); border-color: rgba(0,255,0,.2); }
    .file-counter { font-weight: 600; color: var(--neon-green); }
    .file-name { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: rgba(255,255,255,.8); }

    #clearFileList { color: var(--neon-red); font-size: .8rem; text-align: right; cursor: pointer; text-decoration: none; opacity: .7; transition: opacity .3s; }
    #clearFileList:hover { opacity: 1; text-decoration: underline; }

    .unir-btn {
      background: linear-gradient(135deg, var(--bg-translucent), rgba(0,255,0,.1)); color: var(--text-color);
      padding: 1rem 2rem; border-radius: .75rem; font-weight: 600; font-size: 1rem; border: 1px solid var(--border-translucent);
      width: 100%; cursor: pointer; transition: all .3s cubic-bezier(.4,0,.2,1); display: flex; align-items: center; justify-content: center; gap: .75rem;
      text-shadow: 0 1px 2px rgba(0,0,0,.8); letter-spacing: 1px; text-transform: uppercase; position: relative; overflow: hidden;
    }
    .unir-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0,255,0,.2), transparent); transition: left .5s ease; }
    .unir-btn:hover::before { left: 100%; }
    .unir-btn:hover { background: linear-gradient(135deg, rgba(0,255,0,.15), rgba(0,255,0,.25)); border-color: var(--neon-green); box-shadow: var(--neon-shadow), 0 5px 15px rgba(0,255,0,.2); transform: translateY(-2px); }
    .unir-btn:disabled { opacity: .7; cursor: not-allowed; transform: none; }

    .progress-area { margin-top: 1.5rem; padding: 1rem; border-radius: .75rem; background: var(--bg-translucent); border: 1px solid var(--border-translucent); text-align: center; min-height: 4rem; display: none; }
    .progress-area.show { display: block; }

    .success-message { margin-top: 1.5rem; padding: 1.5rem; border-radius: .75rem; background: rgba(0,255,0,.1); border: 1px solid var(--neon-green); text-align: center; color: var(--text-color); display: none; animation: fadeIn .5s ease-in; }
    .success-message.show { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .fireworks { position: relative; width: 100%; height: 100px; overflow: hidden; }
    .firework {
      position: absolute; width: 5px; height: 5px; background: var(--neon-green); border-radius: 50%;
      animation: explode 1s ease-out forwards; box-shadow: 0 0 10px var(--neon-green), 0 0 20px var(--neon-green);
    }
    @keyframes explode { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(10); opacity: 0; } }

    .download-area { margin-top: 1.5rem; padding: 1rem; border-radius: .75rem; background: var(--bg-translucent); border: 1px solid var(--border-translucent); text-align: center; display: none; }
    .download-area.show { display: block; }

    @media (max-width: 1280px) { .container { width: 95vw; min-height: 70vh; } }
    @media (max-width: 850px) { .content { padding: 2rem 1.5rem; } .app-name h1 { font-size: 2rem; } .page-title h2 { font-size: 1.25rem; } }
  </style>
</head>
<body>
  <!-- Overlay do Menu -->
  <div class="drawer-overlay" id="drawerOverlay"></div>

  <!-- Menu Gaveta -->
  <div class="drawer-menu" id="drawerMenu">
    <div class="drawer-header">
      <span class="drawer-title">Menu</span>
      <button class="drawer-close" id="drawerClose" aria-label="Fechar menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>
<nav class="drawer-nav">
  <a href="/home">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
    <span>Home</span>
  </a>

  <a href="/unir.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
      <line x1="12" y1="22.08" x2="12" y2="12"></line>
    </svg>
    <span>Unir Planilhas</span>
  </a>

  <a href="/dividir.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="9" y1="3" x2="9" y2="21"></line>
    </svg>
    <span>Particionar Planilhas</span>
  </a>

  <a href="/cruzar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="16"></line>
      <line x1="8" y1="12" x2="16" y2="12"></line>
    </svg>
    <span>Cruzar Dados</span>
  </a>

  <a href="/separar_por_coluna.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
    </svg>
    <span>Separar por Coluna</span>
  </a>

  <a href="/duplicados.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
    </svg>
    <span>Duplicados por Coluna</span>
  </a>

  <a href="/duplicados_resolver.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 20v-6"></path><path d="M6 8l6-6 6 6"></path>
      <path d="M6 12h12"></path>
    </svg>
    <span>Resolver Duplicados</span>
  </a>

  <a href="/duplicados_split.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="5 12 12 19 19 12"></polyline>
      <polyline points="5 5 12 12 19 5"></polyline>
    </svg>
    <span>Duplicados (Antigas x Recentes)</span>
  </a>

  <a href="/notificacoes.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="16 18 22 12 16 6"></polyline>
      <polyline points="8 6 2 12 8 18"></polyline>
    </svg>
    <span>Conversor</span>
  </a>

  <a href="/logout" class="logout-btn">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
      <polyline points="16 17 21 12 16 7"></polyline>
      <line x1="21" y1="12" x2="9" y2="12"></line>
    </svg>
    <span>Sair</span>
  </a>
</nav>

  </div>

  <div class="container">
    <div class="content">
      <header class="header">
        <button class="menu-toggle" id="menuToggle" aria-label="Abrir menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>

        <!-- Somente o bot√£o Sair -->
        <div class="actions">
          <a href="/logout" class="btn-logout-top" aria-label="Sair">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Sair</span>
          </a>
        </div>

        <div class="app-name">
          <h1>Planilhex</h1>
          <p>Automatizando Planilhas</p>
        </div>
      </header>

      <div class="page-title">
        <h2>Unir Planilhas</h2>
      </div>

      <form id="unirForm" class="upload-section">
        <label class="upload-btn">
          <span>+ Adicionar Planilhas</span>
          <input type="file" id="fileInput" accept=".xlsx, .csv" multiple style="display:none">
        </label>
        <input type="text" id="outputName" class="output-name" placeholder="Nome do arquivo de sa√≠da" required>
        <select id="formatSelect" class="format-select">
          <option value="xlsx">Excel (.xlsx)</option>
          <option value="csv">CSV (.csv)</option>
          <option value="xls">Excel 97-2003 (.xls)</option>
          <option value="ods">OpenDocument (.ods)</option>
        </select>

        <div id="fileListContainer"></div>
        <a href="#" id="clearFileList" style="display:none">Limpar Lista</a>

        <button type="submit" id="unirBtn" class="unir-btn" disabled>UNIR</button>
      </form>

      <div id="progressArea" class="progress-area">
        <p id="progressText">Aguarde, unindo planilhas...</p>
      </div>
      <div id="successMessage" class="success-message">
        <p>Sucesso! Planilhas unidas com sucesso!</p>
        <div id="fireworks" class="fireworks"></div>
      </div>
      <div id="downloadArea" class="download-area">
        <p>Arquivo unido baixado com sucesso! Clique para baixar novamente:</p>
        <a id="downloadLink" href="#" download>Download</a>
      </div>
    </div>
    <footer style="
  margin-top: 2rem;
  padding: 1.2rem 0;
  text-align: center;
  font-size: 0.9rem;
  color: rgba(245,245,245,0.7);
  border-top: 1px solid rgba(0,255,0,0.25);
  background: rgba(255,255,255,0.02);
  backdrop-filter: blur(10px);
  box-shadow: 0 -1px 10px rgba(0,255,0,0.1);
  letter-spacing: 0.5px;
">
  <p style="margin: 0.2rem 0;">Desenvolvido por <strong style="color:#00ff00;">William de Jesus Santos</strong></p>
  <p style="margin: 0.2rem 0;">
    üìß <a href="mailto:williamffccsm@gmail.com" style="color:#00ff00;text-decoration:none;">williamffccsm@gmail.com</a> &nbsp;|&nbsp;
    üì± <a href="https://wa.me/5561995752332" target="_blank" style="color:#00ff00;text-decoration:none;">WhatsApp: (61) 99575-2332</a>
  üåê <a href="https://www.wjssolucoestecnologicas.com.br" target="_blank" style="color:#00ff00;text-decoration:none;">www.wjssolucoestecnologicas.com.br</a>
  </p>
  <p style="margin:0.2rem 0;font-size:0.8rem;opacity:0.6;">¬© 2025 Planilhex ‚Äî Todos os direitos reservados.</p>
</footer>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Drawer
      const menuToggle = document.getElementById('menuToggle');
      const drawerMenu = document.getElementById('drawerMenu');
      const drawerOverlay = document.getElementById('drawerOverlay');
      const drawerClose = document.getElementById('drawerClose');

      function openDrawer() {
        drawerMenu.classList.add('active');
        drawerOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      }
      function closeDrawer() {
        drawerMenu.classList.remove('active');
        drawerOverlay.classList.remove('active');
        document.body.style.overflow = '';
      }
      menuToggle.addEventListener('click', openDrawer);
      drawerClose.addEventListener('click', closeDrawer);
      drawerOverlay.addEventListener('click', closeDrawer);

      // Form
      const unirForm = document.getElementById('unirForm');
      const fileInput = document.getElementById('fileInput');
      const outputName = document.getElementById('outputName');
      const formatSelect = document.getElementById('formatSelect');
      const unirBtn = document.getElementById('unirBtn');
      const progressArea = document.getElementById('progressArea');
      const progressText = document.getElementById('progressText');
      const successMessage = document.getElementById('successMessage');
      const fireworks = document.getElementById('fireworks');
      const downloadArea = document.getElementById('downloadArea');
      const downloadLink = document.getElementById('downloadLink');
      const fileListContainer = document.getElementById('fileListContainer');
      const clearFileListLink = document.getElementById('clearFileList');

      let selectedFiles = [];

      function checkInputs() {
        unirBtn.disabled = selectedFiles.length === 0 || !outputName.value.trim();
      }

      function updateFileList() {
        fileListContainer.innerHTML = '';
        if (selectedFiles.length > 0) {
          selectedFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
              <span class="file-counter">${index + 1}</span>
              <span class="file-name">${file.name}</span>
            `;
            fileListContainer.appendChild(div);
          });
          clearFileListLink.style.display = 'block';
        } else {
          clearFileListLink.style.display = 'none';
        }
      }

      fileInput.addEventListener('change', (event) => {
        const newFiles = Array.from(event.target.files);
        const key = f => `${f.name}__${f.size}__${f.lastModified}`;
        const atuais = new Set(selectedFiles.map(key));
        newFiles.forEach(f => {
          const k = key(f);
          if (!atuais.has(k)) { selectedFiles.push(f); atuais.add(k); }
        });
        fileInput.value = '';
        updateFileList();
        checkInputs();
      });

      outputName.addEventListener('input', checkInputs);

      clearFileListLink.addEventListener('click', (e) => {
        e.preventDefault();
        selectedFiles = [];
        updateFileList();
        checkInputs();
      });

      unirForm.addEventListener('submit', (e) => {
        e.preventDefault();

        if (selectedFiles.length === 0) {
          alert("Por favor, selecione pelo menos um arquivo.");
          return;
        }

        const formData = new FormData();
        selectedFiles.forEach(file => formData.append('files[]', file));
        const outputFileName = `${outputName.value.trim() || 'unido'}.${formatSelect.value}`;
        formData.append('nome_saida_uniao', outputFileName);

        progressArea.classList.add('show');
        successMessage.classList.remove('show');
        downloadArea.classList.remove('show');
        progressText.textContent = 'Aguarde, enviando e unindo planilhas...';
        unirBtn.disabled = true;

        fetch("/process/unir", { method: 'POST', body: formData })
          .then(response => {
            if (!response.ok) {
              return response.json().then(errData => {
                throw new Error(errData.error || `Erro ${response.status}: ${response.statusText}`);
              }).catch(() => {
                throw new Error(`Erro inesperado do servidor: ${response.status}`);
              });
            }
            const disposition = response.headers.get('Content-Disposition');
            let filename = outputFileName;
            if (disposition && disposition.indexOf('attachment') !== -1) {
              const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
              const matches = filenameRegex.exec(disposition);
              if (matches != null && matches[1]) { filename = matches[1].replace(/['"]/g, ''); }
            }
            return response.blob().then(blob => ({ blob, filename }));
          })
          .then(({ blob, filename }) => {
            const url = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url; a.download = filename || 'arquivo_unido';
            document.body.appendChild(a); a.click(); a.remove();
            setTimeout(() => window.URL.revokeObjectURL(url), 1000);

            progressArea.classList.remove('show');
            successMessage.classList.add('show');
            createFireworks();
            downloadArea.classList.add('show');

            downloadLink.href = url;
            downloadLink.download = filename || 'arquivo_unido';
          })
          .catch(error => {
            console.error('Erro no envio:', error);
            progressArea.classList.add('show');
            progressText.textContent = `Erro: ${error.message}. Tente novamente.`;
          })
          .finally(() => { unirBtn.disabled = false; });
      });

      function createFireworks() {
        fireworks.innerHTML = '';
        for (let i = 0; i < 20; i++) {
          const fw = document.createElement('div');
          fw.className = 'firework';
          fw.style.left = `${Math.random() * 100}%`;
          fw.style.top = `${Math.random() * 50}%`;
          fireworks.appendChild(fw);
          setTimeout(() => fw.remove(), 1000);
        }
      }
    });
  </script>
</body>
</html>
